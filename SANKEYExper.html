<!DOCTYPE html>
<meta charset="utf-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>actor network tool</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">


    <!-- Custom styles for this template -->
    <link href="css/navbar-fixed-top.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="css/MyFontsWebfontsKit.css">
<style>

.node rect {
  cursor: move;
  shape-rendering: crispEdges;
}

.node text {
  color: "#333333";
  
}

.link,
.adding,
.loss,
.loop {
  fill: none;
  stroke-opacity: .9;
}

.title {
  fill: "#ff006a";
}

#textMain,
#imagebox {
    padding:20px 40px; /* Same syntax as box-shadow */
}

#chart {
  overflow: hidden; /* can also be "auto" */
}



</style>
  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <img src="img/logoANT80-01.png" alt="Actor Network Logo" style="float:left;vertical-align:bottom;width:48px;height:48px;">
          <a class="navbar-brand" href="#" style="padding-left:32px;fill:#515151" >Actor Network Tool</a>
                  </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class="active"><a href="#intro">About</a></li>
            <li><a href="#features">Network Articulations</a></li>
            <li><a href="#form">Data Formatting</a></li>
            <!--<li><a href="#quant">Quantitative Demo</a></li>
            <li><a href="#qual">Qualitative Demo</a></li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Generators <span class="caret"></span></a>
              <ul class="dropdown-menu">
              <li><a href="#">Web Generator</a></li>
              <li><a href="#">Omeka Plug-In</a></li>
              <li><a href="#">Wordpress Plug-In</a></li>
              </ul>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="#">PDF Tutorials</a></li>
                <li><a href="#">Vimeo Tutorials</a></li>
                <li><a href="#">Github Wiki</a></li>
                <li><a href="#">Github Repository</a></li>
                </ul>
            </li>

            <li><a href="#contact">Contact</a></li>-->
            
          </ul>
          <!--<ul class="nav navbar-nav navbar-right">
            <li><a href="../navbar/">Default</a></li>
            <li><a href="../navbar-static-top/">Static top</a></li>
            <li class="active"><a href="./">Fixed top <span class="sr-only">(current)</span></a></li>
          </ul>-->
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <div class="jumbotron" id="intro">
        <h2>actor network tool</h2>
        <h4>Embedded Connections, inflections, & feedback</h4><br>
       <span class= "col-md-1"></span><span class= "col-md-10"><p>This example is a quick exercise to illustrate how the default, static and fixed to top navbar work. It includes the responsive CSS and HTML, so it also adapts to your viewport and device.</p>
        <p>Vivamus varius hendrerit cursus. Maecenas eget accumsan eros, sed congue tellus. Sed aliquam urna vel risus ultrices dignissim. Praesent blandit nisi quis urna pretium, sed gravida purus congue. Maecenas sodales fermentum augue, vitae facilisis dui sagittis nec. Nunc nulla metus, sodales at lorem non, posuere consectetur justo. Duis consectetur erat in justo ultrices egestas.</p>
      <p>Vivamus varius hendrerit cursus. Maecenas eget accumsan eros, sed congue tellus. Sed aliquam urna vel risus ultrices dignissim. Praesent blandit nisi quis urna pretium, sed gravida purus congue. Maecenas sodales fermentum augue, vitae facilisis dui sagittis nec. Nunc nulla metus, sodales at lorem non, posuere consectetur justo. Duis consectetur erat in justo ultrices egestas.</p>
    <p>Vivamus varius hendrerit cursus. Maecenas eget accumsan eros, sed congue tellus. Sed aliquam urna vel risus ultrices dignissim. Praesent blandit nisi quis urna pretium, sed gravida purus congue. Maecenas sodales fermentum augue, vitae facilisis dui sagittis nec. Nunc nulla metus, sodales at lorem non, posuere consectetur justo. Duis consectetur erat in justo ultrices egestas.</p></span><span class= "col-md-1"></span>
      </div><br>
      <div> 
        <h2 style="text-align:center; padding-top:20px" id="features">articulation options</h2>
        <p style="text-align:center;line-height:0px">click for demos: connection types and styling, interactive and interpretive features</p><br>
        <span class= "col-md-2" >
            <h4> nodes </h4>
            <form>
              <input type="radio" name="nOpt" value="defaultNodes" onchange="opt=radioC()" checked> default nodes<br>
              <input type="radio" name="nOpt" value="expandedArrows" onchange="opt=radioC()" > expanded arrows<br> 
              <input type="radio" name="nOpt" value="bracketIcons" onchange="opt=radioC()" > bracket icons<br>
              <input type="radio" name="nOpt" value="tbd" onchange="opt=radioC()"><span style="opacity: .25"> other (tbd) </span>
            </form>      
        </span>
        <span class= "col-md-2">
            <h4> links </h4>
            <form>
              <input type="radio" name="lOpt" value="defaultLinks" onchange="opt=radioC()" checked> default links<br>
              <input type="radio" name="lOpt" value="addLoss" onchange="opt=radioC()"> add/loss links<br>
              <input type="radio" name="lOpt" value="feedback" onchange="opt=radioC()"> feedback links<br> 
              <input type="radio" name="lOpt" value="secondary" onchange="opt=radioC()"> secondary systems
            </form> 
        </span>
        <span class= "col-md-2">
            <h4> color & text</h4>
            <form>
              <input type="radio" name="cOpt" value="defaultColor" onchange="opt=radioC()" checked> black & white<br>
              <input type="radio" name="cOpt" value="greysContrast" onchange="opt=radioC()"> greys & contrast<br>
              <input type="radio" name="cOpt" value="colorGradients" onchange="opt=radioC()"> color gradients<br> 
              <input type="radio" name="cOpt" value="googleFonts" onchange="opt=radioC()"> google fonts
            </form> 
        </span>
        <span class= "col-md-2">
            <h4><span style="opacity: .5"> (overlays) </span></h4>
            <form><span style="opacity: .25">
              <input type="radio" name="oOpt" value="defaultTooltips" onchange="opt=radioC()" checked> tooltips variations <br>
              <input type="radio" name="oOpt" value="timeS" onchange="opt=radioC()"> time series<br>
              <input type="radio" name="oOpt" value="typeS" onchange="opt=radioC()"> type series<br> 
              <input type="radio" name="oOpt" value="customData" onchange="opt=radioC()"> custom data
            </span>
            </form>  
        </span>
        <span class= "col-md-2">
            <h4> stories </h4>
            <form>
              <input type="radio" name="sOpt" value="ct" onchange="opt=radioC()" checked> custom titles <br>
              <input type="radio" name="sOpt" value="iconNav" onchange="opt=radioC()"> icon navigation<br>
              <input type="radio" name="sOpt" value="linkNav" onchange="opt=radioC()" > linked narratives <br> 
              <input type="radio" name="sOpt" value="layoutNav" onchange="opt=radioC()" ><span style="opacity: .25"> transect navigation </span>
            </form>  
        </span>
        <span class= "col-md-2">
            <h4><span style="opacity: .5"> (embeds)</span></h4>
            <form><span style="opacity: .25">
              <input type="radio" name="eOpt" value="print/save" id="eOpt" checked> print/save<br>
              <input type="radio" name="eOpt" value="htmlEmbeds" id="eOptA1"> html embeds<br>
              <input type="radio" name="eOpt" value="webGen" id="eOptA2" > web generator<br> 
              <input type="radio" name="eOpt" value="CMS" id="eOptB" > cms plug-ins
            </span></form>  
        </span>
      </div>
      <div id="notes" style="padding-top:120px">
        <br>
      <form> 
      <p id="chartSize" style="text-transform: capitalize"> Drag Nodes to reposition, Hover/Click on Titles for interaction (Greyed-Out Options still in development) </p>
      <p style="font-size:12px; text-transform: capitalize; line-height:10px"> Solid strokes = <em> basic progression from source to target;  </em> fading lines = <em> additions or externalities;  </em> dashed lines = <em> feedback from later stages in process;  </em> dash thin lines =<em> other, secondary networks</em></p>
      <!--<p style="font-size:12px; opacity: .5; text-transform: capitalize">Note: Demonstration below doesn't provide full range of choices, but rather the types under development; alternate data structures link to different tables, see <a href:"/#form"> Data Formatting </a> for details </p>-->
      </div>
      <br>
      <div id="fixPos"><form>
              <h5> Options Selected? <input type="button" name="loadStyled" value="re-Load Styled Diagram" style="font-family: Nanami-HM-ExLt; font-size:12" onclick="opt=radioC(); //add function for all here."></input>
              Good Spacing? <input type="button" name="fixPosition" value="Fix Position" style="font-family: Nanami-HM-ExLt; font-size:12" onclick="fixPosCount = 1; fixed(fixPosCount); console.log(fixPosCount);"></input>
              </h5>
              </form></div>
      <div id="chart">
        <div id="titleBar"><span id="offt" class="col-md-6"></span><span id="titlet" class="col-md-6"><h4 style="text-align:center"> Custom Title Sits Here</h4></span></div>
        <br>
        <div id="icoSpc"></div>
        <br>
        <div id="icoNav"></div>
        <p style="text-align:center; opacity:.5; font-size:8pt">[Icons, Timeline, or Tab Navigation Aides Above]</p>
        <div id="annoBox"><span class="col-md-1"></span><span id="imagebox" class="col-md-5"><p id="caption1"></p></span>
          <span id="textbox" class="col-md-5"><h5 id="textTitle" style="text-align:center"></h5><p id="textMain"></p></span><span class="col-md-1"></span><br>
        </div>
      </div>
      <div id="form" >
        <h2 style="text-align:center; padding-top:20px" id="features">data formatting</h2>
        <p style="text-align:center;line-height:0px">notes on organizing strict and general network data</p><br>
        <span class= "col-md-1"></span><span class= "col-md-10"><p>This example is a quick exercise to illustrate how the default, static and fixed to top navbar work. It includes the responsive CSS and HTML, so it also adapts to your viewport and device.</p>
        <p>Vivamus varius hendrerit cursus. Maecenas eget accumsan eros, sed congue tellus. Sed aliquam urna vel risus ultrices dignissim. Praesent blandit nisi quis urna pretium, sed gravida purus congue. Maecenas sodales fermentum augue, vitae facilisis dui sagittis nec. Nunc nulla metus, sodales at lorem non, posuere consectetur justo. Duis consectetur erat in justo ultrices egestas.</p>
      <p>Vivamus varius hendrerit cursus. Maecenas eget accumsan eros, sed congue tellus. Sed aliquam urna vel risus ultrices dignissim. Praesent blandit nisi quis urna pretium, sed gravida purus congue. Maecenas sodales fermentum augue, vitae facilisis dui sagittis nec. Nunc nulla metus, sodales at lorem non, posuere consectetur justo. Duis consectetur erat in justo ultrices egestas.</p>
    <p>Vivamus varius hendrerit cursus. Maecenas eget accumsan eros, sed congue tellus. Sed aliquam urna vel risus ultrices dignissim. Praesent blandit nisi quis urna pretium, sed gravida purus congue. Maecenas sodales fermentum augue, vitae facilisis dui sagittis nec. Nunc nulla metus, sodales at lorem non, posuere consectetur justo. Duis consectetur erat in justo ultrices egestas.</p></span><span class= "col-md-1"></span>
      </div> 
    </div> <!-- /container -->


<script src="js/d3.min.js"></script>
<script src="js/sankeyAlt.js"></script>
<script src="js/sankeyAppearance.js"></script>
<script src="js/colorbrewer.js"></script>
<script src="js/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')</script>
<script src="js/bootstrap.min.js"></script>
<!--<script src="js/d3-color.v1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')</script>
<script src="js/d3-interpolate.v1.min.js"></script>-->
    

<script>

//--------------------------- radio check-------------------------------------------
      var radioOption={};
      var opt={};
      var fixPosCount=0;

      var draghold=[];

      function fixed(fx, dm){
        if (fx>0){
          d3.selectAll(".node").on('.drag', null);  //d3.selectAll(".node").on('click', '');  
        };
      };


      function radioC(){
          var opts=['nOpt', 'lOpt', 'cOpt', 'oOpt', 'sOpt', 'eOpt'];
          var optsKey=['n', 'l','c','o', 's', 'e'];

        for (var i = 0; i < opts.length; i++) {
          var eleN = document.getElementsByName(opts[i]);
          var eleKey=optsKey[i];

          for (var j=0; j<eleN.length; j++){
            if (eleN[j].checked) {
                radioOption[eleKey]=eleN[j].value;
            }
          };
        };

        //opt=radioOption;
        console.log(radioOption); // to get a sense of updates
        return radioOption;
      };
     
opt=radioC();





//----------------------------------------------------------------------------------
	
var units = "Units";


var width = 1100;

var height = 340; // should make this very adaptable for legibility

// append the svg canvas to the page
var svg = d3.select("#chart").insert("svg", "#icoSpc")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", 
          "translate(" + 0 + "," + 0 + ")");

    //var groupnodes = svg.append("g");
    //var nodebackground = svg.append("g").attr("id", "bkimg");
    var grouplines2 = svg.append("g");
    var grouplines = svg.append("g");
    var groupnodes = svg.append("g");
    var groupother = svg.append("g"); //other system overlays
    var groupicons = svg.append("g"); 
    // options for visuals series should push text/image as part of interaction...js/html and not rely on svg.

// Set the sankey diagram properties
var sankey = d3.sankey()
    .nodeWidth(45)
    .nodePadding(100)
    .size([width-48, height]);

var path = sankey.link();

//----------------------------------------------- EXTRA INTERPERATIVE MARKUP ?------------------------------------------------

//leave until end of main daigram manipulation, likely a new JS file to coordinate this area...


//-------------------------------------------------------------------------DATA OPTIONS opt.l -------------------------------------------------------------------------
var datasources={defaultLinks:"data/sankey.csv",
                  addLoss:"data/sankeyAddLoss.csv",
                  feedback: "data/sankeyLoop.csv",
                  secondary:"data/sankeySecondary.csv",
                 };

var load=datasources[opt.l];   

//---------------------------------------------------------------------------------COLOR OPTIONS-------------------------------------------------------------------------
      var purorange=["#800080", "#8b0078", "#95006c", "#a0005e", "#aa004d", "#b50039", "#c00022", "#ca0008", "#d51500", "#df3500", "#ea5700", "#f47d00", "#ffa500"];
      var greys=[ "#333333", "#424242", "#515151", "#616161", "#707070", "#7f7f7f", "#8e8e8e", "#9e9e9e", "#adadad", "#bcbcbc", "#cbcbcb", "#dbdbdb", "#eaeaea"];

      //var purorg=["#9D0AF0", "#A51CDD", "#C50AF0", "#C91CDD", "#CE2FCA", "#D341B7", "#D754A4", "#DC6692", "#E1797F", "#E58B6C", "#EA9E59", "#EFB046", "#F4C334"];
      //var aquayell=["#38a6b4", "#48acaf", "#59b1aa", "#69b7a5", "#79bca1", "#8ac29c", "#9ac797", "#aacd92", "#bbd38d", "#cbd888", "#dbde84", "#ece37f", "#fce97a"];

      //var blues=["#253494", "#253494", "#2d539b", "#3571a1", "#3e8fa7", "#47acae", "#51b4a1", "#5cbb95", "#67c18a", "#72c881", "#81ce7e", "#9dd58a", "#b7db97", "#cee2a5"];

      /*var color = d3.scale.linear()
          .range(["#38a6b4", "#fce97a"])
          .interpolate(d3.interpolateHcl);*/


        if (opt.c==="colorGradients"){
            var formatNumber = d3.format(",.0f"),    // zero decimal places
            format = function(d) { return formatNumber(d) + " " + units; },
                color = d3.scale.ordinal()
                .domain(d3.range(7))
                .range(colorbrewer.YlGnBu[9]);
                //.range(colorbrewer.YlGnBu[9])
            } else if (opt.c==="greysContrast"){
            var formatNumber = d3.format(",.0f"),    // zero decimal places
            format = function(d) { return formatNumber(d) + " " + units; },
                color = d3.scale.ordinal()
                .domain(d3.range(7))
                .range(greys);

            } else {
            var formatNumber = d3.format(",.0f"),    // zero decimal places
            format = function(d) { return formatNumber(d) + " " + units; },
                color = d3.scale.ordinal()
                .domain([.65, .75])
                .range(["#333","#333"]);
            };

//--------------------------------------------------------DRAWING MAIN SVG----------------------------------------------------------------             

var diagram=d3.csv(load, function(error, data) {


  //console.log(data);


//ORIGINAL BUTTONS set up graph in same style as original example but empty
  graph = {"nodes" : [], "links" : [], "adding":[], "loss":[], "loop":[], "other":[]};// expanded as needed for annotations

    data.forEach(function (d) {

      if (d.type===""){
        graph.nodes.push({ "name": d.source });
        graph.nodes.push({ "name": d.target });

        graph.links.push({ "source": d.source,
                         "target": d.target,
                         "type": d.type,
                         "value": +d.value }); 

      } 
      else if (d.type==="adding"){ // this is presuming no internal value addition, yet..
        graph.nodes.push({ "name": d.target });

        graph.adding.push({"name": d.source,
                        "source":d.source,
                        "target": d.target,
                         "type": d.type,
                         "value": +d.value});

      } else if (d.type==="loss"){
        graph.nodes.push({ "name": d.source });

        graph.loss.push({"name": d.target,
                        "source":d.source,
                        "target": d.target,
                         "type": d.type,
                         "value": +d.value});

      } else if (d.type==="loop"){
        graph.nodes.push({ "name": d.source });
        graph.nodes.push({ "name": d.target });

        graph.loop.push({"name": d.source,
                        "source": d.source,
                        "target": d.target,
                         "type": d.type,
                         "value": +d.value});

      } else if (d.type && d.type.match("other")){ //
        graph.nodes.push({ "name": d.source });
        graph.nodes.push({ "name": d.target });

        graph.other.push({"name": d.source,
                        "source": d.source,
                        "target": d.target,
                         "type": d.type});
      };
      });

    console.log(graph);

//LINK INFO TO SERIES OF NODES...
     // return only the distinct / unique nodes
     graph.nodes = d3.keys(d3.nest()
      //graph.nodes = d3.nest()
       .key(function (d) { return d.name; })
       .map(graph.nodes));

     graph.other.keys = d3.keys(d3.nest() // to track alternate stroke pattern types
      //graph.nodes = d3.nest()
       .key(function (d) { return d.type; })
       .map(graph.other));

    //console.log(graph);

// GRADIENTS FOR EACH NODE/LINK/ETC. STROKE TYPES FOR EACH OTHER LINK highlight gradients... then link, etc.

    sankeyGradients();

    strokedev();  
    
//ICONS... named by node
    var icons=[]; // use length later as short hand for icon interactions.
     graph.nodes.forEach(function (d, i) {
       graph.nodes[i] = { "name": d };
       graph.nodes[i].icon=(d.toLowerCase()+".svg");
       icons.push(d.toLowerCase()+".svg"); // icons have been renamed to match node name (easier than table set-up)
     });



//RUNNING THE SANKEY FORMULA HERE!
  sankey // so just to summing equations here
    .nodes(graph.nodes)
    .links(graph.links)
    .adding(graph.adding)
    .loss(graph.loss)
    .loop(graph.loop)
    .other(graph.other) 
    .layout(32);  

  sankey.addingCurve();
  sankey.lossCurve();
  sankey.loopCurve(); 
  sankey.otherCurve();

  graph.other.nodes.forEach(function(d){
    graph.nodes.forEach(function(e){
      if (e.name===d.name){
        e.str=d.str;
      };
    })
  });

  console.log(graph);

//check options or update options
 if (jQuery.isEmptyObject(opt) || opt!=radioC()){
    opt=radioC();
 };  

//console.log(opt);
var gFont='';
var gFontp='';

if (opt.c==="googleFonts"){
  $("head").append("<link href='https://fonts.googleapis.com/css?family=Fugaz+One|Josefin+Slab' rel='stylesheet'>");
  gFont="Fugaz One";
  gFontp="Josefin Slab"; 
}

// couple functions for the mouseover/mouseout highlights on LINKS/ADDS/LOSS/LOOPS--------------------------------------------------------

    

// highlights mouseover/mouse-out for the NODES AND THEIR LINKS (SOURCE/TARGET)------see gradient file to edit
 

// add in the links
  var link = grouplines.selectAll(".link")
      .data(graph.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .attr("id", function(d){ return d.source.name+d.target.name; })
      .attr("sc", function(d){ return "#"+d.source.name;})
      .attr("tg", function(d){ return "#"+d.target.name;})
      .attr("C1", function(d, i){
              return "url(#grad"+i+")";})
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .attr("stroke", function(d, i){
              return "url(#grad"+i+")";}) 
      .on("mouseover", function(d) {
        var b=(d3.select(this));
        highlight(b);
      })
      .on("mouseout", function(d){
        var b=(d3.select(this));
        normal(b);
      })
      .sort(function(a, b) { return b.dy - a.dy; });

// add the link titles
  link.append("title")
        .text(function(d) {
    		return d.source.name + " → " + 
                d.target.name + "\n" + format(d.value); });

var adding = grouplines2.selectAll(".adding")
      .data(graph.adding)
    .enter().append("path")
      .attr("class", "adding")
      .attr("id", function(d){ return d.source.name+d.target.name; })
      .attr("tg", function(d){ return "#"+d.target.name;})
      .attr("d", function(d){
        return d.path;})
      .attr("C1", function(d, i){
              return "url(#gradA"+i+")";})
      .attr("stroke-width", function(d) { 
             return Math.max(1, d.stroke); })
      .attr("stroke", function(d, i){
              return "url(#gradA"+i+")";})
      .on("mouseover", function(d) {
        var b=(d3.select(this));
        highlight(b);
      })
      .on("mouseout", function(d){
        var b=(d3.select(this));
        normal(b);
      });
              //return d.scolor;})
      //.sort(function(a, b) { return b.dy - a.dy; });
  adding.append("title")
        .text(function(d) {
        return d.name + " → " + 
                d.target.name + "\n" + format(d.value) + " added"; });


var loss = grouplines2.selectAll(".loss")
      .data(graph.loss)
      .enter().append("path")
      .attr("class", "loss")
      .attr("id", function(d){ return d.source.name+d.target.name; })
      .attr("sc", function(d){ return "#"+d.source.name;})
      .attr("d", function(d){
        return d.path;})
      .attr("C1", function(d, i){
              return "url(#gradL"+i+")";})
      .attr("stroke-width", function(d) { 
             return Math.max(1, d.stroke); })
      .attr("stroke", function(d, i){
              return "url(#gradL"+i+")";})
      .on("mouseover", function(d) {
        var b=(d3.select(this));
        highlight(b);
      })
      .on("mouseout", function(d){
        var b=(d3.select(this));
        normal(b);
      });
              //return d.scolor;})
      //.sort(function(a, b) { return b.dy - a.dy; });

  loss.append("title")
        .text(function(d) {
        return d.source.name + " → " + 
                d.name + "\n" + format(d.value) + " lost"; });



var loop = grouplines2.selectAll(".loop")
      .data(graph.loop)
    .enter().append("path")
      .attr("class", "loop")
      .attr("d", function(d){
        return d.path;})
      .attr("id", function(d){ return d.name+d.nameEnd; })
      .attr("sc", function(d){ return "#"+graph.nodes[d.source].name;})
      .attr("tg", function(d){ return "#"+graph.nodes[d.target].name;})
      .attr("C1", function(d, i){
              return "url(#gradF"+i+")";})
      .attr("stroke-dasharray", [5,1])
      .style("stroke-width", function(d) { 
             return Math.max(1, d.stroke); })
      .attr("stroke", function(d, i){
              return "url(#gradF"+i+")";})
      .on("mouseover", function(d) { // need to standardize/rebuilt to finish this!
        var b=(d3.select(this));
        highlight(b);
      })
      .on("mouseout", function(d){
        var b=(d3.select(this));
        normal(b);
      });

  loop.append("title")
        .text(function(d) {
        return d.name + " → " + 
                d.nameEnd + "\n" + format(d.value) + " in feedback"; });


// add in the nodes
  var node = groupnodes.selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("id", function(d){
        return d.name+"NodeGroup";
      })
      .attr("dx", function(d){
        return d.x;
      })
      .attr("dy", function(d){
        return d.y;
      })      
      .attr("transform", function(d) { 
		    return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { 
		      this.parentNode.appendChild(this); })
      .on("drag", dragmove));


  //node.on(".drag", null); set up fix button and then use to trigger .drag, null;

      var triFunction = d3.svg.line()
                        .x(function(d) { return d.x; })
                         .y(function(d) { return d.y; })
                         .interpolate("linear");



    graph.nodes.forEach(function(d){ // the coordinates for all arrow systems
        var lineData=[{"x":d.dx, "y":-5}, {"x":d.dx+5, "y":-5}, {"x":.33*d.dy+d.dx+5, "y":d.dy/2}, {"x":d.dx+5, "y":d.dy+5}, {"x":d.dx, "y":d.dy+5}, {"x":d.dx, "y":0}];
        var lineData0=[{"x":d.dx+5, "y":-5}, {"x":.33*d.dy+d.dx+5, "y":d.dy/2}, {"x":d.dx+5, "y":d.dy+5}]; //excess arrows white line
        var lineData2=[{"x":5, "y":5}, {"x":d.dx-5, "y":5}, {"x":d.dx-5, "y":d.dy-5}, {"x":5, "y":d.dy-5}]; // bracket boxes
        var lineData2a=[{"x":(5+d.dx/10), "y":0}, {"x":(d.dx-5-d.dx/10), "y":0}, {"x":(d.dx-5-d.dx/10), "y":d.dy}, {"x":(5+d.dx/10), "y":d.dy}];
        d.count=0;


        //console.log(lineData);
        d.arrow=triFunction(lineData);
        d.arrow0=triFunction(lineData0);
        d.arrow2=triFunction(lineData2);
        d.arrow2a=triFunction(lineData2a);
      });


  //-------------------------------adding the different articulations/arrows----------------------------------------------    

  // add the rectangles for the nodes (white plus transparency)
    node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .attr("opacity", 1)
      .style("fill", "#ffffff");

  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .attr("C1", function(d) { 
      return d.color = color(d.name.replace(/ .*/, "")); })
      .attr("id", function(d){ return d.name+"Node";})
      .attr("opacity", .9)
      .attr("fill", function(d) { 
      return d.color = color(d.name.replace(/ .*/, "")); })
      .attr("stroke", function(d) { 
      return d.color = color(d.name.replace(/ .*/, "")); })
      .attr("stroke-width", .25)
      .on("mouseover", function(d) {
        var b=(d3.select(this));
        highlightN(b);
        overN(b);
        
      })
      .on("mouseout", function(d){
        var b=(d3.select(this));
        normalN(b);
        overNO(b);
        
      })
      .on("click", function(d){
        d.count+=1;
        var b=(d3.select(this));
        bigAnno(b);

        /*if (d.count%2!==0 || (d3.select("#textTitle").text()==='')){
          //overN(b);
          bigAnno(b);
        } else {
          //overNO(b);
          bigAnnoNO();

        };*/
      })


      //------------------------------- arrow and overlay options-----------------------------------------------------------

        if (opt.n==="bracketIcons"){

           node.append("path") //trianglar mask on node
                  .attr("d", function(d){
                      return d.arrow2;
                  })
                  .style("fill", "#ffffff")
                  .attr("opacity", 1);

          node.append("path") //trianglar mask on node
                  .attr("d", function(d){
                      return d.arrow2a;
                  })
                  .attr("fill", "#ffffff")
                  .attr("stroke", "#ffffff")
                  .attr("id", function(d){ return d.name+"NodeOver";})
                  .attr("opacity", 1)
                  .attr("cursor", "move")
                  .on("mouseover", function(d) {
                      var b=(d3.select(this));
                      highlightN(b);
                      overN(b);
                      
                    })
                    .on("mouseout", function(d){
                      var b=(d3.select(this));
                      normalN(b);
                      overNO(b);
                      
                    })
                    .on("click", function(d){
                         d.count+=1;
                        var b=(d3.select(this));
                        bigAnno(b);

                        /*if (d.count%2!==0 || (d3.select("#textTitle").text()==='')){
                          //overN(b);
                          bigAnno(b);
                        } else {
                          //overNO(b);
                          bigAnnoNO();

                        };*/
                      });

          node.append("image") //add pattern as def then d.val to url icon.
                  .attr("x", function(d){
                    return d.dx/2-14;
                  })
                  .attr("y", function(d){
                    return d.dy/2-14;
                  })
                  .attr("height", 28)
                  .attr("width", 28)
                  .attr("id", function(d){ return d.name+"NodeIcon";})
                  .attr("background", function(d) { 
                      return d.color = color(d.name.replace(/ .*/, "")); })
                  .attr("xlink:href", function(d){
                    return "img/"+d.icon;
                    }) // the question becomes how to provide/link to icons or let people make their own????... specifying by link is easy.... or really by node..
                  .attr("opacity", 1)
                  .attr("cursor", "move")
                  .on("mouseover", function(d) {
                      var b=(d3.select(this));
                      highlightN(b);
                      overN(b);

                    })
                    .on("mouseout", function(d){
                      var b=(d3.select(this));
                      normalN(b);
                      overNO(b);
                      
                    })
                    .on("click", function(d){
                          d.count+=1;
                          var b=(d3.select(this));
                          bigAnno(b);

                          /*if (d.count%2!==0 || (d3.select("#textTitle").text()==='')){
                            //overN(b);
                            bigAnno(b);
                          } else {
                            //overNO(b);
                            bigAnnoNO();

                          };*/      
                      });

            // need something to pull and fill icons (svg series). . . 

        };

        if (opt.n==="expandedArrows"){

              node.append("path") //triangle basic for arrow (underlay)
                  .attr("d", function(d){
                      return d.arrow;
                  })
                  .attr("fill", "#ffffff")
                  .attr("opacity", 1);

              node.append("path") //triangle basic for arrow
                  .attr("d", function(d){
                      return d.arrow;
                  })
                  .attr("id", function(d){ return d.name+"Arrow";})
                  .attr("fill", function(d) {
                    return d.color = color(d.name.replace(/ .*/ , "")); })
                  .attr("opacity", .9);

              node.append("path") //triangle edge for arrow
                  .attr("d", function(d){
                      return d.arrow0;
                  })
                  .attr("stroke", function(d){
                      return "#ffffff";})
                  .attr("stroke-linecap", "round")
                  .attr("fill", "none")
                  .attr("stroke-width", "5px"); 
        };

// add in the title for the nodes
  node.append("text") 
      .attr("x", function(d) { 
            if (opt.n==="bracketIcons"){
                return d.dx/2;
                } else {
                  return d.dx-5;
                };
                })
      .attr("y", -7)
      .attr("id", function(d) { return d.name; })
      .attr("dy", ".35em")
      .attr("text-anchor", function(d) { 
            if (opt.n==="bracketIcons"){
                return "middle";
                } else {
                  return "end";
                };
                })
      .attr("stroke", "none")
      .attr("transform", null)
      .attr("font-size", 10)
      .attr("font-family", function(d){
        if (opt.c!=="googleFonts"){
          return "TrendHMSans-One";
          } else {
            return gFont;
          };
          }) // set this to function with google fonts
      .text(function(d) { return d.name; });

//----------------------------------THE OVERLAID SYSTEMS----------------------------------------------------------------------------------------

    node.append("rect")
      .attr("x", function(d){
        var x=d3.select(this).attr("dx");
        return Number(x)-2;
      })
      .attr("y", function(d){
        var y=d3.select(this).attr("dy");
        return Number(y)-2;
      })
      .attr("id", function(d){return d.name+"otherNode";})
      .attr("width", function(d){
        var xw=d3.select("#"+d.name+"Node").attr("width");
        return (Number(xw)+4);
      })
      .attr("height", function(d){
        var yh=d3.select("#"+d.name+"Node").attr("height");
        return (Number(yh)+4);
      })
      .attr("stroke", function(d){
        if (d.str){return "#333333";} else {return "none"};
      })
      .attr("stroke-width", 1)
      .attr("fill", "none")
      .attr("stroke-dasharray", function(d){
        if (d.str){return d.str[0], d.str[1];};
      });

  var other = groupnodes.selectAll(".linkOther")
      .data(graph.other)
      .enter().append("path") //x1,x2 y1,y2
      .attr("class", "linkOther")
      .attr("d", function(d){
        return d.path;})
      .attr("id", function(d){ return d.source+d.target+"other"; })
      .attr("stroke-dasharray", function(d){
        return d.str[0], d.str[1];
      })
      .attr("stroke", function(d){
        if (d.str){return "#333333";} else {return "none"};
      })
      .attr("stroke-width", 1)
      .attr("fill", "none")
      ;
//--------------------------------------------------------ICON NAVIGATIONS HERE-------------------------------------------------------------------------------------
var icoN=graph.nodes.length;
var icoW=icoN*24+(icoN-1)*24;
var icoS=0;//start to be added to
var countR=(width/24)/2;
var rowCts=[];//start new row on index [i]....
var rowC =1;

if (icoW<=width){
  icoS=((width-icoW)/2);
}else{
  rowC=Math.ceil(icoN/countR); //number of rows... try to stack/center
  var indexBr=Math.ceil(iconN/rowC); // of icons per row
  var icoBW=indexBr*24+(indexBr-1)*24;
  icoS=(width-icoBW)/2;

  for (var i=1; i=rowC; i++){
    rowCts.push(i*(indexBr-1)); //so able to test icon[i]<rowCts[j]....to treat each row seperately.
  };
};//find row #s

graph.nodes.forEach(function(node, i){
  if (rowC>1){
      for (var j=1;j<=rowC;j++){ // at 2
          if (i>=rowCts[j-1]&&i<rowCts[j]){ //greater than first break, less than or equal to second break
            node.ix=((i-rowCts[j-1])*48)+icoS;
            node.iy=(j*38)+12; 
          };
      };
    };
    node.ix=(i*48)+icoS;
    node.iy=12;
});

console.log(graph.nodes);


var svg2 = d3.select("#icoNav").append("svg")
    .attr("width", width)
    .attr("height", 38*rowC);


  var iconsLower = svg2.selectAll(".iNav")
          .data(graph.nodes)
          .enter().append("g");

    iconsLower.append("image")
          .attr("class", "iNav")
          .attr("id", function(d){ return d.name+"iNav";})
          .attr("x", function(d){return d.ix;})
          .attr("y", function(d){return d.iy;})
          .attr("xlink:href", function(d){
                      return "img/"+d.icon;
          })
          .attr("height", 24)
          .attr("width", 24)
          .attr("opacity", 1)
          .on("mouseover", function(d) {
            var b=(d3.select(this));
            b.attr("opacity", .5);
            d3.select("#"+d.name+"itNav").attr("opacity", .5);

            highlightN(b);
            overN(b);

          })
          .on("mouseout", function(d) {
            var b=(d3.select(this));
            b.attr("opacity", 1);
            d3.select("#"+d.name+"itNav").attr("opacity", 1);

            normalN(b);
            overNO(b);            
          })
          .on("click", function(d){
                d.count+=1;
                var b=(d3.select(this));
                bigAnno(b);

                /*if (d.count%2!==0 || (d3.select("#textTitle").text()==='')){
                  //overN(b);
                  bigAnno(b);
                } else {
                  //overNO(b);
                  bigAnnoNO();

                };*/
            });


  iconsLower.append("text")
                  .text(function(d){ return d.name;})
                  .attr("id", function(d){ return d.name+"itNav";})
                  .attr("x", function(d){return d.ix+12;})
                  .attr("y", function(d){return d.iy-3;})
                  .attr("text-anchor", "middle")
                  .attr("font-size", 12)
                  .attr("fill", "#333333");
                  //.on("mouseover", function(d) {})
                  //.on("mouseout", function(d) {})
                  //.on("click", function(d) {})


// -------------------------------------------------the function for moving the nodes in both the x and the y
function dragmove(d) {
    d3.select(this).attr("transform", 
        "translate(" + (d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))) + "," + (
                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
            ) + ")");
    sankey.relayout();
    sankey.addingCurve();
    sankey.lossCurve();
    sankey.loopCurve();
    sankey.otherCurve();

    link.attr("d", path);
    adding.attr("d", function(d){
        return d.path;});
    loss.attr("d", function(d){
        return d.path;});
    loop.attr("d", function(d){
        return d.path;});
    other.attr("d", function(d){
        return d.path;});
    overNOAll();

    //console.log(d);
  };

draghold.push(dragmove);

});


</script>

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>-->
    <script src="js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>

</body>
</html>
